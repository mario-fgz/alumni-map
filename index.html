<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Science Alumni Map</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .legend {
      position: absolute; bottom: 16px; left: 16px;
      background: #fff; border-radius: 8px; padding: 8px 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15); font-family: system-ui, sans-serif;
    }
    .popup-card { width: 260px; font-family: system-ui, sans-serif; }
    .popup-card img { width: 100%; border-radius: 6px; margin: 6px 0; }
    .popup-card .name { font-weight: 700; font-size: 16px; }
    .popup-card .role { font-style: italic; color: #555; margin-bottom: 6px; }
    .tooltip {
      pointer-events: none;
      position: absolute; z-index: 2;
      background: rgba(0,0,0,0.8); color: #fff; padding: 6px 8px;
      border-radius: 6px; font-size: 12px; font-family: system-ui, sans-serif;
      transform: translate(-50%, -120%); white-space: nowrap;
    }
  </style>
</head>
<body>
<div id="map"></div>
<div class="legend">Hover circles for counts • Click student icons for bios</div>

<script>
  // Your values
  mapboxgl.accessToken = 'pk.eyJ1IjoibWFyaW9mZ3oiLCJhIjoiY21lMjlwajc4MHAxdDJxcHUwcWJhaTMzZSJ9.155BX_OMpbLYEk8AGx1unw';
  const styleUrl = 'mapbox://styles/mariofgz/cmd6wlcaj03hv01srcgvpbtos';

  const map = new mapboxgl.Map({
    container: 'map',
    style: styleUrl,
    center: [120, 5],
    zoom: 2,
    projection: 'mercator'
  });

  // Fallback if style has no background
  map.once('styledata', () => {
    const hasBg = (map.getStyle().layers || []).some(l => l.type === 'background');
    if (!hasBg) map.setStyle('mapbox://styles/mapbox/light-v11');
  });

  map.on('error', e => console.error('Mapbox error →', e && e.error));

  // Hover tooltip DOM
  const tip = document.createElement('div');
  tip.className = 'tooltip';
  tip.style.display = 'none';
  document.body.appendChild(tip);
  function showTip(lngLat, html) {
    const p = map.project(lngLat);
    tip.style.left = p.x + 'px';
    tip.style.top = p.y + 'px';
    tip.innerHTML = html;
    tip.style.display = 'block';
    tip._lngLat = lngLat;
  }
  function hideTip(){ tip.style.display = 'none'; tip._lngLat = null; }
  map.on('move', () => { if (tip._lngLat) showTip(tip._lngLat, tip.innerHTML); });

  map.on('load', async () => {
    // 1) Alumni circles (breakpoints, colors, no stroke)
    map.addSource('alumni-circles', { type: 'geojson', data: './alumni_grouped.geojson' });

    map.addLayer({
      id: 'alumni-circles-layer',
      type: 'circle',
      source: 'alumni-circles',
      paint: {
        // sizes by breakpoints (px): 0–10, 11–999, 1000–1999, 2000+
        'circle-radius': [
          'step', ['to-number', ['get', 'count']], 
          5,      11, 12,     1000, 18,     2000, 25
        ],
        // colors by breakpoints: #496dee, #d95e8b, #e7975a, #dad662
        'circle-color': [
          'step', ['to-number', ['get', 'count']],
          '#496dee',     // 0–10
          11, '#d95e8b', // 11–999
          1000, '#e7975a', // 1000–1999
          2000, '#dad662'  // 2000+
        ],
        'circle-opacity': 0.75,
        'circle-stroke-width': 0 // remove stroke
      }
    });

    // Hover tooltip on circles
    map.on('mousemove', 'alumni-circles-layer', (e) => {
      const f = e.features?.[0]; if (!f) return;
      const p = f.properties || {};
      const label =
        p.location_key ||
        (p.STATE && p.COUNTRY ? `${p.STATE}, ${p.COUNTRY}` : (p.COUNTRY || 'Location'));
      const count = p.count ?? p.Count ?? p.COUNT ?? 0;
      const coords = f.geometry?.coordinates || [e.lngLat.lng, e.lngLat.lat];
      showTip(coords, `<b>${label}</b><br>Alumni: ${count}`);
      map.getCanvas().style.cursor = 'pointer';
    });
    map.on('mouseleave', 'alumni-circles-layer', () => { hideTip(); map.getCanvas().style.cursor=''; });

    // 2) Info icons on top of circles (click to “pop” into area)
    // Using built-in Maki icon "information-15"
    map.addLayer({
      id: 'alumni-circles-info',
      type: 'symbol',
      source: 'alumni-circles',
      layout: {
        'icon-image': 'information-15',
        'icon-size': 1.0,
        'icon-allow-overlap': true,
        'text-field': '',
        'visibility': 'visible'
      },
      minzoom: 1
    });

    map.on('click', 'alumni-circles-info', (e) => {
      const f = e.features?.[0]; if (!f) return;
      const coords = f.geometry?.coordinates || [e.lngLat.lng, e.lngLat.lat];
      const p = f.properties || {};
      const label =
        p.location_key ||
        (p.STATE && p.COUNTRY ? `${p.STATE}, ${p.COUNTRY}` : (p.COUNTRY || 'Location'));
      const count = p.count ?? 0;

      // Zoom in a bit so nearby profile pins are visible
      map.easeTo({ center: coords, zoom: Math.max(map.getZoom(), 4), duration: 800 });

      // A small hint popup
      new mapboxgl.Popup({ offset: 12 })
        .setLngLat(coords)
        .setHTML(`<div style="font-family:system-ui,sans-serif;font-size:12px">
            <b>${label}</b><br/>Alumni: ${count}<br/><br/>
            <span>Tip: click nearby student pins to view bios.</span>
          </div>`)
        .addTo(map);
    });

    // 3) Random aesthetic connection lines between alumni points
    // Build a few random pairs client-side
    try {
      const res = await fetch('./alumni_grouped.geojson');
      const gj = await res.json();
      const pts = (gj.features || []).filter(f => f.geometry?.type === 'Point');
      const N = Math.min(15, Math.floor(pts.length / 3));
      const used = new Set(), lines = [];
      const pick = () => {
        let i = Math.floor(Math.random() * pts.length), guard = 0;
        while (used.has(i) && guard++ < 50) i = Math.floor(Math.random() * pts.length);
        used.add(i); return i;
      };
      for (let i=0;i<N && pts.length>=2;i++){
        const a = pts[pick()], b = pts[pick()];
        if (!a || !b || a===b) continue;
        lines.push({ type:'Feature', geometry:{ type:'LineString',
          coordinates:[ a.geometry.coordinates, b.geometry.coordinates ] }, properties:{} });
      }
      map.addSource('connections', { type:'geojson', data:{ type:'FeatureCollection', features:lines } });
      map.addLayer({
        id:'connections-layer',
        type:'line',
        source:'connections',
        paint:{
          'line-color':'#6b7280',
          'line-opacity':0.35,
          'line-width':1.5
        }
      }, 'alumni-circles-layer'); // draw behind icons but above base
    } catch(e){ console.warn('Connection lines skipped:', e); }

    // 4) Student profiles (pins + click popup)
    map.loadImage('https://docs.mapbox.com/mapbox-gl-js/assets/custom_marker.png', (err, img) => {
      if (err) throw err;
      if (!map.hasImage('student-icon')) map.addImage('student-icon', img);

      map.addSource('alumni-profiles', { type:'geojson', data:'./alumni_profiles.geojson' });
      map.addLayer({
        id:'alumni-profiles-layer',
        type:'symbol',
        source:'alumni-profiles',
        layout:{
          'icon-image':'student-icon',
          'icon-size':0.08,
          'icon-allow-overlap': true,
          'text-field':['get','name'],
          'text-size':12,
          'text-offset':[0,1],
          'text-anchor':'top'
        },
        paint:{ 'text-color':'#111' }
      });

      map.on('click','alumni-profiles-layer',(e)=>{
        const p=e.features[0].properties;
        const coords=e.features[0].geometry.coordinates.slice();
        const html=`<div class="popup-card">
          <div class="name">${p.name||''}</div>
          <div class="role">${(p.job_title||'')}${p.employer?(' — '+p.employer):''}</div>
          ${p.image?`<img src="${p.image}" alt="${p.name||'profile'}" />`:''}
          <div class="overview">${p.overview||''}</div>
          ${p.career_link?`<div><a href="${p.career_link}" target="_blank" rel="noopener">Read career story →</a></div>`:''}
        </div>`;
        new mapboxgl.Popup({ maxWidth:'320px' }).setLngLat(coords).setHTML(html).addTo(map);
      });

      map.on('mouseenter','alumni-profiles-layer',()=>map.getCanvas().style.cursor='pointer');
      map.on('mouseleave','alumni-profiles-layer',()=>map.getCanvas().style.cursor='');
    });
  });
</script>
</body>
</html>
