<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Science Alumni Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <style>
    /* Fill the screen, including mobile dynamic viewport */
    html, body, #map { height: 100dvh; margin: 0; }

    .popup-card { width: 260px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .popup-card img { width: 100%; border-radius: 6px; margin: 6px 0; }
    .popup-card .name { font-weight: 700; font-size: 16px; }
    .popup-card .role { font-style: italic; color: #555; margin-bottom: 6px; }

    /* Hover tooltip (disabled on touch via JS) */
    .tooltip{
      pointer-events:none; position:absolute; z-index: 4;
      background: rgba(0,0,0,0.85); color:#fff; padding:6px 8px;
      border-radius:6px; font-size:12px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      transform: translate(-50%, -120%); white-space: nowrap; display:none;
    }

    /* Mobile tweaks */
    @media (max-width: 640px) {
      .popup-card { width: 220px; }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="tooltip" id="tooltip"></div>

  <script>
    // ====== MAPBOX CONFIG ======
    mapboxgl.accessToken = 'pk.eyJ1IjoibWFyaW9mZ3oiLCJhIjoiY21lMjlwajc4MHAxdDJxcHUwcWJhaTMzZSJ9.155BX_OMpbLYEk8AGx1unw';

    // ====== MAP INIT (safe basemap) ======
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v11',
      center: [150, -5],
      zoom: 1.6,
      projection: 'mercator',
      renderWorldCopies: false
    });

    // Basic nav control
    map.addControl(new mapboxgl.NavigationControl({ visualizePitch: false }), 'bottom-right');

    map.on('error', e => console.error('Mapbox error â†’', e && e.error));

    // ====== Touch / Mobile detection & gestures ======
    const IS_TOUCH = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
    if (IS_TOUCH) {
      map.scrollZoom.disable();     // avoid hijacking page scroll
      map.dragRotate.disable();
      map.touchZoomRotate.enable({ around: 'center' });
      map.doubleClickZoom.disable();
    }

    // ====== Tooltip helpers (desktop) ======
    const tip = document.getElementById('tooltip');
    function showTip(lngLat, html){
      const p = map.project(lngLat);
      tip.style.left = p.x + 'px';
      tip.style.top  = p.y + 'px';
      tip.innerHTML  = html;
      tip.style.display = 'block';
      tip._lngLat = lngLat;
    }
    function hideTip(){ tip.style.display = 'none'; tip._lngLat = null; }
    map.on('move', () => { if (tip._lngLat) showTip(tip._lngLat, tip.innerHTML); });

    // ====== Circle styling (mobile-aware sizes) ======
    const sizeByCount = IS_TOUCH
      ? ['step', ['to-number', ['get', 'count']], 4, 11, 10, 1000, 16, 2000, 22]  // mobile
      : ['step', ['to-number', ['get', 'count']], 5, 11, 12, 1000, 18, 2000, 25]; // desktop

    // Colors by breakpoint
    const colorByCount = ['step', ['to-number', ['get', 'count']],
      '#496dee', 11, '#d95e8b', 1000, '#e7975a', 2000, '#dad662'
    ];

    // ====== Helpers for merging/cleaning ======
    const U = s => (s ?? '').toString().trim();
    const NORM = s => U(s).normalize('NFKD').replace(/\p{Diacritic}/gu,'').toUpperCase();
    const isUnknown = v => !U(v) || NORM(v) === 'UNKNOWN';

    const COUNTRY_ALIASES = new Map([
      ['USA','UNITED STATES'], ['U.S.A.','UNITED STATES'], ['US','UNITED STATES'], ['UNITED STATES OF AMERICA','UNITED STATES'],
      ['UK','UNITED KINGDOM'], ['GREAT BRITAIN','UNITED KINGDOM'],
      ['ENGLAND','UNITED KINGDOM'], ['SCOTLAND','UNITED KINGDOM'], ['WALES','UNITED KINGDOM'], ['NORTHERN IRELAND','UNITED KINGDOM'],
      ['VIENNA','AUSTRIA'],
      ['HONG KONG SAR','HONG KONG'], ['MACAO SAR','MACAO'], ['MACAU','MACAO']
    ]);

    const CENTRE = {
      'UNITED STATES': [-98.5795, 39.8283],
      'CHINA':         [104.1954, 35.8617],
      'AUSTRALIA-NSW': [151.2093, -33.8688], // Sydney
    };

    function toTitle(upper){
      return U(upper).toLowerCase().replace(/\b\w/g, m => m.toUpperCase())
        .replace('Usa','USA').replace('Uk','UK').replace('Macao','Macao');
    }

    // Decide bucket & coords per rules
    function bucketKeyAndCoord(p, coord){
      let country = NORM(p.COUNTRY || p.country || p.Country);
      let state   = NORM(p.STATE   || p.state   || p.State);
      let city    = NORM(p.CITY    || p.city    || p.City);

      // If city/state says LONDON â†’ UK
      if (city === 'LONDON' || state === 'LONDON') country = 'UNITED KINGDOM';

      // Respect HK / MACAO / TAIWAN as separate from China
      if (country === 'CHINA' && (state === 'HONG KONG' || state === 'MACAO' || state === 'MACAU' || state === 'TAIWAN')){
        country = (state === 'MACAU') ? 'MACAO' : state;
        state = '';
      }

      // Canonicalise country aliases
      if (COUNTRY_ALIASES.has(country)) country = COUNTRY_ALIASES.get(country);

      // AUSTRALIA: Unknown/blank state â†’ NSW
      if (country === 'AUSTRALIA' && (isUnknown(state) || !state)) state = 'NSW';

      // USA & CHINA: one dot per country
      if (country === 'UNITED STATES'){
        return { key: 'UNITED STATES', label: 'United States', coord: CENTRE['UNITED STATES'] };
      }
      if (country === 'CHINA'){
        return { key: 'CHINA', label: 'China', coord: CENTRE['CHINA'] };
      }

      // AUSTRALIA: keep by state
      if (country === 'AUSTRALIA'){
        const label = state ? `${state}, Australia` : 'Australia';
        const c = (coord && coord.length===2) ? coord : CENTRE['AUSTRALIA-NSW'];
        return { key: `AUSTRALIA|${state||'NSW'}`, label, coord: c };
      }

      // Everyone else: one dot per country
      return { key: `COUNTRY|${country}`, label: toTitle(country), coord };
    }

    // ====== Load & merge the circle data ======
    map.on('load', async () => {
      // Load raw file
      const resp = await fetch('./alumni_grouped.geojson');
      const rawGJ = await resp.json();

      // Fold features into buckets with summed counts & collected coords
      const buckets = new Map();
      for (const f of (rawGJ.features || [])){
        if (!f.geometry || f.geometry.type !== 'Point') continue;
        const coord = f.geometry.coordinates;
        const p = f.properties || {};
        const cnt = Number(p.count ?? p.COUNT ?? p.Count ?? 0) || 0;

        const { key, label, coord: targetCoord } = bucketKeyAndCoord(p, coord);
        if (!buckets.has(key)){
          buckets.set(key, { label, coords: [], sum: 0, forcedCoord: targetCoord });
        }
        const b = buckets.get(key);
        b.sum += cnt;
        if (targetCoord) {
          b.forcedCoord = targetCoord; // hard centroid (US/China/AU states)
        } else if (coord && coord.length===2) {
          b.coords.push(coord);       // collect for mean later
        }
      }

      // Build merged features (mean coord for non-forced)
      function meanCoord(arr){
        if (!arr.length) return null;
        const sx = arr.reduce((s,c)=>s+c[0],0), sy = arr.reduce((s,c)=>s+c[1],0);
        return [sx/arr.length, sy/arr.length];
      }

      const merged = { type: 'FeatureCollection', features: [] };
      for (const [key, b] of buckets){
        const coord = b.forcedCoord || meanCoord(b.coords);
        if (!coord) continue;
        merged.features.push({
          type: 'Feature',
          geometry: { type: 'Point', coordinates: coord },
          properties: { label: b.label, count: b.sum }
        });
      }

      // Nudge a couple island cases by label (safety)
      for (const f of merged.features){
        const lbl = (f.properties.label || '').toUpperCase();
        if (lbl.includes('FRENCH POLYNESIA')) f.geometry.coordinates = [-149.4068, -17.6509];
        if (lbl.includes('NEW CALEDONIA'))    f.geometry.coordinates = [166.457,  -22.271];
        if (lbl.includes('MICRONESIA'))       f.geometry.coordinates = [158.215,    6.885];
      }

      // Add source
      map.addSource('alumni-circles', { type: 'geojson', data: merged, generateId: true });

      // Auto-fit & nudge east/south so Pacific islands arenâ€™t on the seam
      try {
        const pts = merged.features;
        if (pts.length) {
          let minLng =  180, minLat =  90, maxLng = -180, maxLat = -90;
          pts.forEach(f => {
            const [lng, lat] = f.geometry.coordinates;
            if (lng < minLng) minLng = lng;
            if (lng > maxLng) maxLng = lng;
            if (lat < minLat) minLat = lat;
            if (lat > maxLat) maxLat = lat;
          });
          const PAD = IS_TOUCH ? 20 : 60;
          const bounds = new mapboxgl.LngLatBounds([minLng, minLat], [maxLng, maxLat]);
          map.fitBounds(bounds, { padding: PAD, maxZoom: 1.8, duration: 0 });
          const c = map.getCenter();
          map.easeTo({ center: [c.lng + 20, c.lat - 5], duration: 0 });
        }
      } catch (e) { console.warn('fit/nudge skipped:', e); }

      // ------- Circle layers -------
      map.addLayer({
        id: 'alumni-circles-layer',
        type: 'circle',
        source: 'alumni-circles',
        paint: {
          'circle-radius': sizeByCount,
          'circle-color': colorByCount,
          'circle-opacity': 0.80,
          'circle-stroke-width': 0,
          'circle-blur': 0.15
        },
        filter: ['==', ['geometry-type'], 'Point']
      });

      map.addLayer({
        id: 'alumni-circles-hover',
        type: 'circle',
        source: 'alumni-circles',
        paint: {
          'circle-radius': [
            'case',
            ['boolean', ['feature-state', 'hover'], false],
            ['+', sizeByCount, 4],
            0
          ],
          'circle-color': colorByCount,
          'circle-opacity': 0.90,
          'circle-stroke-width': 0
        }
      });

      // ------- Tooltip -------
      let hoveredId = null;

      if (!IS_TOUCH) {
        map.on('mousemove', 'alumni-circles-layer', (e) => {
          const f = e.features?.[0]; if (!f) return;
          if (hoveredId !== null) map.setFeatureState({ source: 'alumni-circles', id: hoveredId }, { hover: false });
          hoveredId = f.id;
          map.setFeatureState({ source: 'alumni-circles', id: hoveredId }, { hover: true });

          const p = f.properties || {};
          const label = p.label || 'Unknown location';
          const count = p.count ?? 0;
          const coords = f.geometry?.coordinates || [e.lngLat.lng, e.lngLat.lat];
          showTip(coords, `<b>${label}</b><br>Alumni: ${count}`);
          map.getCanvas().style.cursor = 'pointer';
        });

        map.on('mouseleave', 'alumni-circles-layer', () => {
          if (hoveredId !== null) {
            map.setFeatureState({ source: 'alumni-circles', id: hoveredId }, { hover: false });
            hoveredId = null;
          }
          hideTip();
          map.getCanvas().style.cursor = '';
        });
      } else {
        // Touch: tap to show a small popup instead of hover tooltip
        map.on('click', 'alumni-circles-layer', (e) => {
          const f = e.features?.[0]; if (!f) return;
          const p = f.properties || {};
          const label = p.label || 'Unknown location';
          const count = p.count ?? 0;
          new mapboxgl.Popup({ offset: 12, closeButton: true })
            .setLngLat(e.lngLat)
            .setHTML(`<div style="font-family:system-ui,sans-serif;font-size:13px">
              <b>${label}</b><br/>Alumni: ${count}
            </div>`)
            .addTo(map);
        });
      }

      // ====== CONNECTION LINES ======
      try {
        const pts = merged.features;

        // Find NSW feature (label starts with "NSW, Australia")
        const hub = pts.find(f => (f.properties?.label || '').toUpperCase().startsWith('NSW, AUSTRALIA'));
        const hubCoord = hub?.geometry?.coordinates || [151.2093, -33.8688]; // Sydney fallback

        // Curved lines from NSW to random other points
        const others = pts.filter(f => f !== hub);
        const pickN  = Math.min(18, others.length);
        const shuffled = others.sort(() => Math.random() - 0.5).slice(0, pickN);

        function curvedLine(a, b) {
          const [x1,y1] = a, [x2,y2] = b;
          const mx = (x1 + x2) / 2, my = (y1 + y2) / 2;
          const dx = x2 - x1, dy = y2 - y1;
          const len = Math.hypot(dx, dy) || 1;
          const nx = -dy / len, ny = dx / len;
          const strength = 10;
          const cx = mx + nx * strength, cy = my + ny * strength;
          const steps = 30, coords = [];
          for (let t=0; t<=1; t+=1/steps) {
            const x = (1-t)*(1-t)*x1 + 2*(1-t)*t*cx + t*t*x2;
            const y = (1-t)*(1-t)*y1 + 2*(1-t)*t*cy + t*t*y2;
            coords.push([x,y]);
          }
          return coords;
        }

        const lines = shuffled.map(f => ({
          type: 'Feature',
          geometry: { type: 'LineString', coordinates: curvedLine(hubCoord, f.geometry.coordinates) },
          properties: {}
        }));

        map.addSource('connections', { type:'geojson', data:{ type:'FeatureCollection', features: lines } });

        map.addLayer({
          id:'connections-layer',
          type:'line',
          source:'connections',
          layout: { 'line-cap': 'round', 'line-join': 'round' },
          paint:{
            'line-color': '#00bcd4',
            'line-opacity': ['interpolate', ['linear'], ['zoom'], 2, 0.25, 4, 0.45, 6, 0.6],
            'line-width': 2.2,
            'line-dasharray': [0, 2, 3]
          }
        });

        // Animated dasharray
        let step = 0;
        const seq = [[0,2,3],[1,2,3],[2,2,3],[3,2,3]];
        function tick() {
          if (!map.getLayer('connections-layer')) return;
          map.setPaintProperty('connections-layer', 'line-dasharray', seq[step]);
          step = (step + 1) % seq.length;
          setTimeout(() => requestAnimationFrame(tick), 350);
        }
        requestAnimationFrame(tick);
      } catch (e) { console.warn('Connections skipped:', e); }

      // ====== STUDENT PROFILES ======
      try {
        const resP = await fetch('./alumni_profiles.geojson');
        const profiles = await resP.json();

        const seen = new Map();
        const offsets = [[0,0],[14,0],[-14,0],[0,14],[0,-14],[12,12],[-12,12],[12,-12],[-12,-12]];

        profiles.features.forEach((f) => {
          if (!f.geometry || f.geometry.type !== 'Point') return;
          const p = f.properties || {};
          const img = p.image;

          // De-overlap offsets for duplicate coordinates
          const key = f.geometry.coordinates.join(',');
          const i = seen.get(key) || 0;
          seen.set(key, i + 1);
          const [ox, oy] = offsets[i % offsets.length];

          // Circular avatar element
          const el = document.createElement('div');
          const AVATAR = IS_TOUCH ? 26 : 30;
          el.className = 'avatar-marker';
          el.style.width = AVATAR + 'px';
          el.style.height = AVATAR + 'px';
          el.style.borderRadius = '50%';
          el.style.background = '#ddd center/cover no-repeat';
          el.style.boxShadow = '0 0 0 2px #fff, 0 2px 10px rgba(0,0,0,.25)';
          el.style.transition = 'transform .15s ease';
          el.style.cursor = 'pointer';

          if (img) {
            el.style.backgroundImage = `url('${img}')`;
          } else {
            const initials = (p.name || '').split(/\s+/).map(s => s[0]).join('').slice(0,2).toUpperCase();
            el.style.display = 'grid';
            el.style.placeItems = 'center';
            el.style.background = '#888';
            el.style.color = '#fff';
            el.style.fontSize = '12px';
            el.style.fontWeight = '700';
            el.textContent = initials || 'ðŸ‘¤';
          }

          el.addEventListener('mouseenter', () => el.style.transform = 'scale(1.12)');
          el.addEventListener('mouseleave', () => el.style.transform = 'scale(1)');

          const marker = new mapboxgl.Marker({ element: el, anchor: 'center', offset: [ox, oy] })
            .setLngLat(f.geometry.coordinates)
            .addTo(map);

          // Robust link field + button styling
          const rawLink =
            p.career_link || p.careerLink || p.link || p.url || p.Link || p.URL || p['Link to career story'];
          const safeLink = rawLink
            ? (String(rawLink).startsWith('http') ? String(rawLink) : 'https://' + String(rawLink))
            : null;

          const html = `
            <div class="popup-card">
              <div class="name">${p.name || ''}</div>
              <div class="role">${(p.job_title || '')}${p.employer ? ' â€” ' + p.employer : ''}</div>
              ${p.image ? `<img src="${p.image}" alt="${p.name || 'profile'}" />` : ''}
              <div class="overview">${p.overview || ''}</div>
              ${
                safeLink
                  ? `<div style="margin-top:10px;">
                       <a href="${safeLink}" target="_blank" rel="noopener noreferrer"
                          style="display:inline-block;padding:8px 12px;background-color:#496dee;color:white;
                                 border-radius:4px;text-decoration:none;font-weight:600;font-size:13px;">
                         ðŸŽ“ Read career story â†’
                       </a>
                     </div>`
                  : ''
              }
            </div>`;
          marker.setPopup(new mapboxgl.Popup({ offset: 14, maxWidth: '320px' }).setHTML(html));
        });
      } catch (e) {
        console.warn('Profiles markers skipped:', e);
      }
    });
  </script>
</body>
</html>
