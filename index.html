<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Science Alumni Map</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .legend {
      position: absolute; bottom: 16px; left: 16px;
      background: #fff; border-radius: 8px; padding: 8px 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      z-index: 3;
    }
    .legend .row { display: flex; gap: 12px; align-items: center; }
    .legend .key { display:inline-flex; align-items:center; gap:6px; }
    .legend .dot { display:inline-block; border-radius: 50%; }
    .popup-card { width: 260px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .popup-card img { width: 100%; border-radius: 6px; margin: 6px 0; }
    .popup-card .name { font-weight: 700; font-size: 16px; }
    .popup-card .role { font-style: italic; color: #555; margin-bottom: 6px; }
    .tooltip{
      pointer-events:none; position:absolute; z-index: 4;
      background: rgba(0,0,0,0.85); color:#fff; padding:6px 8px;
      border-radius:6px; font-size:12px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      transform: translate(-50%, -120%); white-space: nowrap; display:none;
    }
  </style>
</head>
<body>
<div id="map"></div>

<!-- Legend -->
<div class="legend">
  <div style="font-weight:600;margin-bottom:6px">Alumni (count)</div>
  <div class="row">
    <span class="key"><span class="dot" style="width:10px;height:10px;background:#496dee"></span>0â€“10</span>
    <span class="key"><span class="dot" style="width:14px;height:14px;background:#d95e8b"></span>11â€“999</span>
    <span class="key"><span class="dot" style="width:18px;height:18px;background:#e7975a"></span>1000â€“1999</span>
    <span class="key"><span class="dot" style="width:22px;height:22px;background:#dad662"></span>2000+</span>
  </div>
</div>

<div class="tooltip" id="tooltip"></div>

<script>
  // ====== MAPBOX CONFIG ======
  mapboxgl.accessToken = 'pk.eyJ1IjoibWFyaW9mZ3oiLCJhIjoiY21lMjlwajc4MHAxdDJxcHUwcWJhaTMzZSJ9.155BX_OMpbLYEk8AGx1unw';
  const styleUrl = 'mapbox://styles/mariofgz/cmd6wlcaj03hv01srcgvpbtos';

  // ====== MAP INIT ======
  const map = new mapboxgl.Map({
    container: 'map',
    style: styleUrl,
    center: [120, 5],
    zoom: 2,
    projection: 'mercator'
  });

  // Fallback if style has no background (prevents blank basemap)
  map.once('styledata', () => {
    const hasBg = (map.getStyle().layers || []).some(l => l.type === 'background');
    if (!hasBg) {
      console.warn('No background layer detected; switching to light-v11');
      map.setStyle('mapbox://styles/mapbox/light-v11');
    }
  });

  map.on('error', e => console.error('Mapbox error â†’', e && e.error));

  // ====== Tooltip helpers ======
  const tip = document.getElementById('tooltip');
  function showTip(lngLat, html){
    const p = map.project(lngLat);
    tip.style.left = p.x + 'px';
    tip.style.top  = p.y + 'px';
    tip.innerHTML  = html;
    tip.style.display = 'block';
    tip._lngLat = lngLat;
  }
  function hideTip(){
    tip.style.display = 'none';
    tip._lngLat = null;
  }
  map.on('move', () => { if (tip._lngLat) showTip(tip._lngLat, tip.innerHTML); });

  // Common expressions for circles (sizes/colors)
  const sizeByCount = ['step', ['to-number', ['get', 'count']], 5, 11, 12, 1000, 18, 2000, 25];
  const colorByCount = ['step', ['to-number', ['get', 'count']],
    '#496dee',   // 0â€“10
    11,  '#d95e8b',   // 11â€“999
    1000, '#e7975a',  // 1000â€“1999
    2000, '#dad662'   // 2000+
  ];

  map.on('load', async () => {
    // ====== ALUMNI CIRCLES ======
    map.addSource('alumni-circles', {
      type: 'geojson',
      data: './alumni_grouped.geojson',
      generateId: true // enables feature-state hover without IDs in file
    });

    map.addLayer({
      id: 'alumni-circles-layer',
      type: 'circle',
      source: 'alumni-circles',
      paint: {
        'circle-radius': sizeByCount,
        'circle-color': colorByCount,
        'circle-opacity': 0.80,
        'circle-stroke-width': 0,
        'circle-blur': 0.15
      },
      filter: ['==', ['geometry-type'], 'Point']
    });

    // Hover emphasis layer
    map.addLayer({
      id: 'alumni-circles-hover',
      type: 'circle',
      source: 'alumni-circles',
      paint: {
        'circle-radius': [
          'case',
          ['boolean', ['feature-state', 'hover'], false],
          ['+', sizeByCount, 4],
          0
        ],
        'circle-color': colorByCount,
        'circle-opacity': 0.90,
        'circle-stroke-width': 0
      }
    });

    // Tooltip + hover state
    let hoveredId = null;
    map.on('mousemove', 'alumni-circles-layer', (e) => {
      const f = e.features?.[0];
      if (!f) return;

      // feature-state: hover
      if (hoveredId !== null) map.setFeatureState({ source: 'alumni-circles', id: hoveredId }, { hover: false });
      hoveredId = f.id;
      map.setFeatureState({ source: 'alumni-circles', id: hoveredId }, { hover: true });

      // Build location label: City/State, Country (skip "Unknown")
      const p = f.properties || {};
      const clean = v => (v && String(v).toLowerCase() !== 'unknown') ? String(v) : '';
      const country = clean(p.COUNTRY || p.country || p.Country);
      const state   = clean(p.STATE   || p.state   || p.State);
      const city    = clean(p.city    || p.City    || p.CITY);
      let label = country || 'Unknown location';
      if (state && country) label = `${state}, ${country}`;
      if (city  && country) label = `${city}, ${country}`;
      if (!country && (state || city)) label = state || city;

      const count = p.count ?? p.Count ?? p.COUNT ?? 0;
      const coords = f.geometry?.coordinates || [e.lngLat.lng, e.lngLat.lat];
      showTip(coords, `<b>${label}</b><br>Alumni: ${count}`);
      map.getCanvas().style.cursor = 'pointer';
    });
    map.on('mouseleave', 'alumni-circles-layer', () => {
      if (hoveredId !== null) {
        map.setFeatureState({ source: 'alumni-circles', id: hoveredId }, { hover: false });
        hoveredId = null;
      }
      hideTip();
      map.getCanvas().style.cursor = '';
    });

    // Info icons on top of circles
    map.addLayer({
      id: 'alumni-circles-info',
      type: 'symbol',
      source: 'alumni-circles',
      minzoom: 3,
      layout: {
        'icon-image': 'information-15',
        'icon-size': 0.9,
        'icon-allow-overlap': true
      }
    });

    map.on('click', 'alumni-circles-info', (e) => {
      const f = e.features?.[0]; if (!f) return;
      const coords = f.geometry?.coordinates || [e.lngLat.lng, e.lngLat.lat];
      const p = f.properties || {};
      const clean = v => (v && String(v).toLowerCase() !== 'unknown') ? String(v) : '';
      const country = clean(p.COUNTRY || p.country || p.Country);
      const state   = clean(p.STATE   || p.state   || p.State);
      const city    = clean(p.city    || p.City    || p.CITY);
      let label = country || 'Unknown location';
      if (state && country) label = `${state}, ${country}`;
      if (city  && country) label = `${city}, ${country}`;
      if (!country && (state || city)) label = state || city;
      const count = p.count ?? 0;

      map.easeTo({ center: coords, zoom: Math.max(map.getZoom(), 4), duration: 800 });
      new mapboxgl.Popup({ offset: 12 })
        .setLngLat(coords)
        .setHTML(`<div style="font-family:system-ui,sans-serif;font-size:12px">
          <b>${label}</b><br/>Alumni: ${count}<br/><br/>
          Tip: click nearby student pins to view bios.
        </div>`)
        .addTo(map);
    });

// ====== CONNECTION LINES ======
try {
  const res = await fetch('./alumni_grouped.geojson');
  const gj  = await res.json();
  const pts = (gj.features || []).filter(f => f.geometry?.type === 'Point');

  if (pts.length < 2) throw new Error('Not enough points for connections');

  const N   = Math.min(18, Math.floor(pts.length / 3)); // a few more lines
  const used = new Set(), lines = [];

  const pick = () => {
    let i = Math.floor(Math.random() * pts.length), guard = 0;
    while (used.has(i) && guard++ < 50) i = Math.floor(Math.random() * pts.length);
    used.add(i); return i;
  };

  // curved arc between two [lng,lat] points
  function curvedLine(a, b) {
    const [x1,y1] = a, [x2,y2] = b;
    const mx = (x1 + x2) / 2, my = (y1 + y2) / 2;
    const dx = x2 - x1, dy = y2 - y1;
    const len = Math.hypot(dx, dy) || 1;
    const nx = -dy / len, ny = dx / len;
    const strength = 10; // bend amount
    const cx = mx + nx * strength, cy = my + ny * strength;
    const steps = 30, coords = [];
    for (let t=0; t<=1; t+=1/steps) {
      const x = (1-t)*(1-t)*x1 + 2*(1-t)*t*cx + t*t*x2;
      const y = (1-t)*(1-t)*y1 + 2*(1-t)*t*cy + t*t*y2;
      coords.push([x,y]);
    }
    return coords;
  }

  for (let i=0; i<N; i++){
    const a = pts[pick()], b = pts[pick()];
    if (!a || !b || a === b) continue;
    lines.push({
      type:'Feature',
      geometry:{ type:'LineString', coordinates: curvedLine(a.geometry.coordinates, b.geometry.coordinates) },
      properties:{}
    });
  }

  map.addSource('connections', {
    type:'geojson',
    data:{ type:'FeatureCollection', features: lines }
  });
  const beforeId = map.getLayer('alumni-profiles-layer') ? 'alumni-profiles-layer' : undefined;

  map.addLayer({
    id:'connections-layer',
    type:'line',
    source:'connections',
    layout: {
      'line-cap': 'round',
      'line-join': 'round'
    },
    paint:{
      'line-color':'#4ecdc4',
      'line-opacity': ['interpolate', ['linear'], ['zoom'], 2, 0.18, 4, 0.35, 6, 0.5],
      'line-width': 1.8,
      'line-dasharray': [0, 2, 3] // dotted pattern (will animate)
    }
  }, beforeId);

  // Animated dasharray (gentle flowing effect)
  let step = 0;
  const seq = [
    [0, 2, 3], 
    [1, 2, 3],
    [2, 2, 3],
    [3, 2, 3]
  ];
  function tick() {
    if (!map.getLayer('connections-layer')) return;
    map.setPaintProperty('connections-layer', 'line-dasharray', seq[step]);
    step = (step + 1) % seq.length;
    setTimeout(() => requestAnimationFrame(tick), 350);
  }
  requestAnimationFrame(tick);

} catch(e) {
  console.warn('Connection lines skipped:', e);
}
  // ====== STUDENT PROFILES (photo avatars + click popups) ======
try {
  const resP = await fetch('./alumni_profiles.geojson');
  const profiles = await resP.json();

  profiles.features.forEach((f) => {
    if (!f.geometry || f.geometry.type !== 'Point') return;
    const p = f.properties || {};
    const img = p.image; // e.g., images/rene-wootton-tomlin.jpg

    // Create circular avatar element
    const el = document.createElement('div');
    el.className = 'avatar-marker';
    el.style.width = '30px';
    el.style.height = '30px';
    el.style.borderRadius = '50%';
    el.style.background = '#ddd center/cover no-repeat';
    el.style.boxShadow = '0 0 0 2px #fff, 0 2px 10px rgba(0,0,0,.25)';
    el.style.transition = 'transform .15s ease';
    el.style.cursor = 'pointer';

    if (img) {
      el.style.backgroundImage = `url('${img}')`;
    } else {
      // Fallback: initials if no image
      const initials = (p.name || '')
        .split(/\s+/).map(s => s[0]).join('').slice(0,2).toUpperCase();
      el.style.display = 'grid';
      el.style.placeItems = 'center';
      el.style.background = '#888';
      el.style.color = '#fff';
      el.style.fontSize = '12px';
      el.style.fontWeight = '700';
      el.textContent = initials || 'ðŸ‘¤';
    }

    el.addEventListener('mouseenter', () => el.style.transform = 'scale(1.12)');
    el.addEventListener('mouseleave', () => el.style.transform = 'scale(1)');

    const marker = new mapboxgl.Marker({ element: el, anchor: 'center' })
      .setLngLat(f.geometry.coordinates)
      .addTo(map);

    const html = `
      <div class="popup-card">
        <div class="name">${p.name || ''}</div>
        <div class="role">${(p.job_title || '')}${p.employer ? ' â€” ' + p.employer : ''}</div>
        ${p.image ? `<img src="${p.image}" alt="${p.name || 'profile'}" />` : ''}
        <div class="overview">${p.overview || ''}</div>
        ${p.career_link ? `<div><a href="${p.career_link}" target="_blank" rel="noopener">Read career story â†’</a></div>` : ''}
      </div>`;

    marker.setPopup(new mapboxgl.Popup({ offset: 14, maxWidth: '320px' }).setHTML(html));
  });
} catch (e) {
  console.warn('Profiles markers skipped:', e);
}
    map.on('click','alumni-profiles-layer',(e)=>{
        const p=e.features[0].properties;
        const coords=e.features[0].geometry.coordinates.slice();
        const html=`<div class="popup-card">
          <div class="name">${p.name||''}</div>
          <div class="role">${(p.job_title||'')}${p.employer?(' â€” '+p.employer):''}</div>
          ${p.image?`<img src="${p.image}" alt="${p.name||'profile'}" />`:''}
          <div class="overview">${p.overview||''}</div>
          ${p.career_link?`<div><a href="${p.career_link}" target="_blank" rel="noopener">Read career story â†’</a></div>`:''}
        </div>`;
        new mapboxgl.Popup({ maxWidth:'320px' }).setLngLat(coords).setHTML(html).addTo(map);
      });

      map.on('mouseenter','alumni-profiles-layer',()=>map.getCanvas().style.cursor='pointer');
      map.on('mouseleave','alumni-profiles-layer',()=>map.getCanvas().style.cursor='');
    });
  });
</script>
</body>
</html>
